var app=angular.module("mrImage",[]);app.directive("mrImage",["$timeout",function(a){return{restrict:"A",scope:{src:"=mrSrc",maxWidth:"=?mrMaxWidth",maxHeight:"=?mrMaxHeight",aspectRatio:"=?mrAspectRatio",orgScale:"=?mrScale",drawer:"=?mrDrawer",selector:"=?mrSelector"},template:'<div mr-image-selector mr-model="selector" mr-aspect-ratio="aspectRatio" mr-scale="scale"ng-style="{ \'height\': scaleValuePx(height, scale), \'width\': scaleValuePx(width, scale) }"></div><div mr-image-drawer mr-model="drawer" mr-scale="scale"ng-style="{ \'height\': scaleValuePx(height, scale), \'width\': scaleValuePx(width, scale) }"></div><img ng-src="{{src}}" width="{{scaleValue(width, scale)}}" height="{{scaleValue(height, scale)}}">',link:function(b,c){function d(){angular.isUndefined(b.image)||a(function(){if(b.height=b.height||b.image.height,b.width=b.width||b.image.width,angular.isUndefined(b.orgScale)&&angular.isDefined(b.maxWidth)&&angular.isDefined(b.maxHeight)){var a=b.maxWidth>=b.width?1:b.maxWidth/b.width,d=b.maxHeight>=b.height?1:b.maxHeight/b.height;b.scale=a*b.height<=b.maxHeight?a:d}else b.scale=angular.isUndefined(b.orgScale)&&angular.isDefined(b.maxWidth)?b.maxWidth>=b.width?1:b.maxWidth/b.width:angular.isUndefined(b.orgScale)&&angular.isDefined(b.maxHeight)?b.maxHeight>=b.height?1:b.maxHeight/b.height:b.orgScale||1;c.css("width",b.scaleValue(b.width,b.scale)+"px"),c.css("height",b.scaleValue(b.height,b.scale)+"px")})}function e(a){b.image=new Image,b.image.onload=function(){d()},b.image.src=a}c.addClass("mr-image"),e(b.src),b.$watch("maxWidth",d,!0),b.$watch("maxHeight",d,!0),b.scaleValue=function(a,b){return Math.round(a*b)},b.scaleValuePx=function(a,b){return Math.round(a*b)+"px"}}}}]),app.directive("mrImageDrawer",function(){return{restrict:"A",scope:{rects:"=mrModel",scale:"=mrScale"},template:'<div ng-repeat="rect in rects" class="mr-image-drawer-rect" ng-style="genRectStyle(rect)"></div>',link:function(a){function b(b){return Math.round(b*a.scale)}a.genRectStyle=function(a){return{position:"absolute",cursor:"pointer",top:b(a.y1)+"px",left:b(a.x1)+"px",width:b(a.x2-a.x1)+"px",height:b(a.y2-a.y1)+"px"}}}}}),app.directive("mrImageSelector",function(){function a(a){var b,c={top:0,left:0},d=a&&a[0].ownerDocument;return b=d.documentElement,void 0!==typeof a[0].getBoundingClientRect&&(c=a[0].getBoundingClientRect()),{top:c.top+(window.pageYOffset||b.scrollTop)-(b.clientTop||0),left:c.left+(window.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}}return{restrict:"A",scope:{selector:"=?mrModel",scale:"=mrScale",src:"=?mrSrc",aspectRatio:"=?mrAspectRatio"},link:function(b,c){function d(a,b,c){N.css("display","block"),O.css("right",b-a.left+"px"),R.css("left",b-a.right+"px"),P.css("left",a.left+"px"),P.css("right",a.right+"px"),P.css("bottom",c-a.top+"px"),Q.css("left",a.left+"px"),Q.css("right",a.right+"px"),Q.css("top",c-a.bottom+"px")}function e(){J[0].documentElement.className=J[0].documentElement.className.replace(" mr-user-select","")}function f(){J[0].documentElement.className+=" mr-user-select"}function g(){J.bind("mousemove",j),J.bind("mouseup",k)}function h(){J.unbind("mousemove",j),J.unbind("mouseup",k)}function i(b){f();var d=a(c);S=b.pageX-d.left,T=b.pageY-d.top,U=!0,g()}function j(d){U=!1;var e=a(c),f=d.pageX-e.left,g=d.pageY-e.top;b.$apply(function(){l(S,T,f,g)})}function k(){e(),U&&b.$apply(B),h()}function l(a,b,d,e){var f=c.css("height").replace("px",""),g=c.css("width").replace("px","");d=0>d?0:d,d=d>g?g:d,e=0>e?0:e,e=e>f?f:e;var h={top:e>b?b:e,bottom:e>b?f-e:f-b,left:d>a?a:d,right:d>a?g-d:g-a};y(h,g,f)}function m(){J.bind("mousemove",p),J.bind("mouseup",q)}function n(){J.unbind("mousemove",p),J.unbind("mouseup",q)}function o(a){a.stopPropagation(),f(),Y=angular.element(a.target).attr("class").replace("mr-drag-handle","").replace("mr-drag-line","").trim(),V=a.pageX,W=a.pageY,X={top:parseInt(K.css("top")),bottom:parseInt(K.css("bottom")),left:parseInt(K.css("left")),right:parseInt(K.css("right"))},m()}function p(a){var d=c.css("height").replace("px",""),e=c.css("width").replace("px",""),f=a.pageX-V,g=a.pageY-W,h={top:X.top,bottom:X.bottom,left:X.left,right:X.right};"n"==Y[0]?h.top+=g:"s"==Y[0]&&(h.bottom-=g),"w"==Y[0]||"w"==Y[1]?h.left+=f:("e"==Y[0]||"e"==Y[1])&&(h.right-=f);var i;(h.top>=d-h.bottom||h.bottom>=d-h.top)&&(i=h.top,h.top=d-h.bottom,h.bottom=d-i),(h.left>=e-h.right||h.right>=e-h.left)&&(i=h.left,h.left=e-h.right,h.right=e-i),h.top=h.top<0?0:h.top,h.bottom=h.bottom<0?0:h.bottom,h.left=h.left<0?0:h.left,h.right=h.right<0?0:h.right,I&&("n"==Y&&(h.left=e-(h.right+(d-h.top-h.bottom)*I)),"s"==Y&&(h.right=e-(h.left+(d-h.top-h.bottom)*I)),("w"==Y||"nw"==Y||"ne"==Y)&&(h.top=d-(h.bottom+(e-h.left-h.right)/I),h.top<0&&(h.top=0,"w"==Y[0]||"w"==Y[1]?h.left=e-(h.right+(d-h.top-h.bottom)*I):h.right=e-(h.left+(d-h.top-h.bottom)*I))),("e"==Y||"se"==Y||"sw"==Y)&&(h.bottom=d-(h.top+(e-h.left-h.right)/I),h.bottom<0&&(h.bottom=0,"e"==Y[0]||"e"==Y[1]?h.right=e-(h.left+(d-h.top-h.bottom)*I):h.left=e-(h.right+(d-h.top-h.bottom)*I)))),b.$apply(function(){y(h,e,d)})}function q(){e(),n()}function r(){J.bind("mousemove",u),J.bind("mouseup",v)}function s(){J.unbind("mousemove",u),J.unbind("mouseup",v)}function t(a){a.stopPropagation(),f(),V=a.pageX,W=a.pageY,X={top:parseInt(K.css("top")),bottom:parseInt(K.css("bottom")),left:parseInt(K.css("left")),right:parseInt(K.css("right"))},r()}function u(a){var d=c.css("height").replace("px",""),e=c.css("width").replace("px",""),f=a.pageX-V,g=a.pageY-W,h={top:X.top+g,bottom:X.bottom-g,left:X.left+f,right:X.right-f};h.top<0&&(h.bottom=h.bottom+h.top,h.top=0),h.bottom<0&&(h.top=h.bottom+h.top,h.bottom=0),h.left<0&&(h.right=h.right+h.left,h.left=0),h.right<0&&(h.left=h.left+h.right,h.right=0),b.$apply(function(){y(h,e,d)})}function v(){e(),s()}function w(a){return Math.round(a/b.scale)}function x(a){return Math.round(a*b.scale)}function y(a,c,e){a&&(I&&(S>a.left?a.left=c-(a.right+(e-a.top-a.bottom)*I):a.right=c-(a.left+(e-a.top-a.bottom)*I),a.top<0&&(a.top=0,a.left=c-(a.right+(e-a.top-a.bottom)*I)),a.bottom<0&&(a.bottom=0,a.right=c-(a.left+(e-a.top-a.bottom)*I)),a.left<0&&(a.left=0,a.top=e-(a.bottom+(c-a.left-a.right)/I)),a.right<0&&(a.right=0,a.bottom=e-(a.top+(c-a.left-a.right)/I))),d(a,c,e),K.css("display","block"),K.css({top:a.top+"px",bottom:a.bottom+"px",left:a.left+"px",right:a.right+"px"}),$(),H.x1=w(a.left),H.y1=w(a.top),H.x2=w(c-a.right),H.y2=w(e-a.bottom),$=b.$watch("selector",E,!0))}function z(){Z||(c.bind("mousedown",i),L.bind("mousedown",o),M.bind("mousedown",o),K.bind("mousedown",t),Z=!0)}function A(){Z&&(c.unbind("mousedown",i),L.unbind("mousedown",o),M.unbind("mousedown",o),K.unbind("mousedown",t),Z=!1)}function B(){H.x1=H.x2=H.y1=H.y2=void 0,K.css("display","none"),N.css("display","none")}function C(){return angular.isUndefined(H.x1)&&angular.isUndefined(H.x2)&&angular.isUndefined(H.y1)&&angular.isUndefined(H.y2)}function D(){return isFinite(H.x1)&&isFinite(H.x2)&&isFinite(H.y1)&&isFinite(H.y2)}function E(a,b){return F(a.enabled),angular.equals(a,b)||a.enabled!=b.enabled||C()?void 0:D()?void l(x(a.x1),x(a.y1),x(a.x2),x(a.y2)):void console.error("[ERROR]: Selector position value (x1, x2, y1, y2) is not a valid number.")}function F(a){H.enabled="boolean"!=typeof a?!0:a,H.enabled&&D()?(z(),c.css("z-index",300),K.css("display","block"),N.css("display","block")):H.enabled?(z(),c.css("z-index",300),B()):(A(),c.css("z-index",100),K.css("display","none"),N.css("display","none"))}function G(){var a=document.createElement("canvas"),c=a.getContext("2d"),d=1/b.$parent.scale,e=(H.x2-H.x1)*d,f=(H.y2-H.y1)*d;return a.width=e,a.height=f,c.drawImage(b.$parent.image,H.x1*d,H.y1*d,e,f,0,0,e,f),a.toDataURL("image/png")}b.selector=b.selector||{};var H=b.selector,I=b.aspectRatio;b.$watch("aspectRatio",function(a){I=a});var J=angular.element(document),K=angular.element('<div class="mr-box"><div class="mr-line top"></div><div class="mr-line bottom"></div><div class="mr-line left"></div><div class="mr-line right"></div></div>'),L=angular.element('<div class="mr-drag-line n"></div><div class="mr-drag-line s"></div><div class="mr-drag-line w"></div><div class="mr-drag-line e"></div>'),M=angular.element('<div class="mr-drag-handle nw"></div><div class="mr-drag-handle n"></div><div class="mr-drag-handle ne"></div><div class="mr-drag-handle w"></div><div class="mr-drag-handle e"></div><div class="mr-drag-handle sw"></div><div class="mr-drag-handle s"></div><div class="mr-drag-handle se"></div>');K.append(L).append(M),c.append(K);var N=angular.element('<div class="mr-shadow">'),O=angular.element('<div class="mr-shadow left">'),P=angular.element('<div class="mr-shadow center top">'),Q=angular.element('<div class="mr-shadow center bottom">'),R=angular.element('<div class="mr-shadow right">');N.append(O).append(P).append(Q).append(R),c.append(N);var S,T,U=!1;c.bind("mousedown",i);var V,W,X,Y;L.bind("mousedown",o),M.bind("mousedown",o),K.bind("mousedown",t);var Z=!0;H.clear=B,H.enabled="boolean"!=typeof H.enabled?!0:H.enabled;var $=b.$watch("selector",E,!0);H.crop=G}}});